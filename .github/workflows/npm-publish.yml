name: Publish to NPM

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 4.0.1 or 4.0.0-pre.66)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (test without publishing or committing)'
        required: false
        type: boolean
        default: true

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    environment: npm-production
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install semver library
        run: npm install --no-save semver@7

      - name: Determine npm tag
        id: npm-tag
        shell: bash
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          VERSION_RAW="${{ inputs.version }}"
          echo "branch=${CURRENT_BRANCH} default=${DEFAULT_BRANCH} version=${VERSION_RAW}"

          VERSION=$(node -e "const s=require('semver');const v=s.valid(process.argv[1])||s.valid(s.coerce(process.argv[1])); if(!v){console.error('Invalid semver:', process.argv[1]); process.exit(1)}; console.log(v)" "$VERSION_RAW")
          INPUT_MAJOR=$(node -e "const s=require('semver');console.log(s.major(process.argv[1]))" "$VERSION")

          IS_VERSION_BRANCH=false
          if [[ "$CURRENT_BRANCH" =~ ^v?([0-9]+)\.([0-9]+)$ ]]; then
            BRANCH_MAJOR="${BASH_REMATCH[1]}"
            BRANCH_TAG="v${BRANCH_MAJOR}"
            IS_VERSION_BRANCH=true
          fi

          if [[ "$CURRENT_BRANCH" != "$DEFAULT_BRANCH" && "$IS_VERSION_BRANCH" != "true" ]]; then
            echo "‚ùå Publishing only from $DEFAULT_BRANCH or version branches (vX.Y, e.g. v4.0)"
            exit 1
          fi

          if [[ "$IS_VERSION_BRANCH" == "true" && "$INPUT_MAJOR" != "$BRANCH_MAJOR" ]]; then
            echo "‚ùå Version major ($INPUT_MAJOR) does not match branch major ($BRANCH_MAJOR)."
            exit 1
          fi

          if node -e "const s=require('semver');process.exit(s.prerelease(process.argv[1])?0:1)" "$VERSION"; then
            if [[ "$IS_VERSION_BRANCH" != "true" ]]; then
              echo "‚ùå Prereleases only from version branches (vX.Y)"
              exit 1
            fi
            echo "tag=next-${BRANCH_TAG}" >> $GITHUB_OUTPUT
            echo "version_tag=" >> $GITHUB_OUTPUT
            echo "next_tag=" >> $GITHUB_OUTPUT
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "Publishing as prerelease with tag: next-${BRANCH_TAG}"
          else
            VERSION_TAG="latest-v${INPUT_MAJOR}"
            NEXT_TAG="next-v${INPUT_MAJOR}"
            if [[ "$CURRENT_BRANCH" == "$DEFAULT_BRANCH" ]]; then
              echo "tag=latest" >> $GITHUB_OUTPUT
              echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
              echo "next_tag=${NEXT_TAG}" >> $GITHUB_OUTPUT
              echo "is_stable=true" >> $GITHUB_OUTPUT
              echo "Publishing stable with tags: latest, ${VERSION_TAG}, ${NEXT_TAG}"
            else
              echo "tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
              echo "version_tag=" >> $GITHUB_OUTPUT
              echo "next_tag=${NEXT_TAG}" >> $GITHUB_OUTPUT
              echo "is_stable=true" >> $GITHUB_OUTPUT
              echo "Publishing stable with tags: ${VERSION_TAG}, ${NEXT_TAG}"
            fi
          fi

      - name: Update npm
        run: npm install -g npm@latest

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Check if CI passed for this commit
        id: ci-status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              head_sha: context.sha,
              status: 'completed',
              per_page: 1
            });

            const ciPassed = runs.workflow_runs.length > 0 &&
                           runs.workflow_runs[0].conclusion === 'success';

            console.log(`CI status for ${context.sha}: ${ciPassed ? 'PASSED ‚úÖ' : 'NOT PASSED ‚ùå'}`);
            core.setOutput('passed', ciPassed.toString());

            return ciPassed;

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Setup .NET
        if: steps.ci-status.outputs.passed != 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Start dev server
        if: steps.ci-status.outputs.passed != 'true'
        shell: bash
        run: |
          set -Eeuo pipefail
          dotnet run --project dev/Dev.csproj &
          echo $! > server.pid
          READY=""
          for i in {1..30}; do
            if curl -s -o /dev/null -w '%{http_code}' http://localhost:5000 | grep -q "200"; then
              echo "Server is ready!"
              READY="yes"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done
          [ -n "$READY" ] || { echo "‚ùå Server did not become ready in time"; exit 1; }

      - name: Run tests
        if: steps.ci-status.outputs.passed != 'true'
        run: npm test

      - name: Stop dev server
        if: always() && steps.ci-status.outputs.passed != 'true'
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Build distribution files with version
        run: npm run dist -- ${{ inputs.version }} ${{ github.sha }}

      - name: Verify build artifacts
        run: |
          echo "Verifying @vidyano/core build outputs..."
          test -f dist/core/index.js || { echo "‚ùå dist/core/index.js missing"; exit 1; }
          test -f dist/core/index.d.ts || { echo "‚ùå dist/core/index.d.ts missing"; exit 1; }
          test -f dist/core/index.min.js || { echo "‚ùå dist/core/index.min.js missing"; exit 1; }

          echo "Verifying @vidyano/vidyano build outputs..."
          test -f dist/vidyano/index.js || { echo "‚ùå dist/vidyano/index.js missing"; exit 1; }
          test -f dist/vidyano/index.d.ts || { echo "‚ùå dist/vidyano/index.d.ts missing"; exit 1; }
          test -f dist/vidyano/index.min.js || { echo "‚ùå dist/vidyano/index.min.js missing"; exit 1; }

          echo "‚úÖ All build artifacts verified successfully"

      - name: Verify package.json versions
        shell: bash
        run: |
          set -Eeuo pipefail
          V_IN="${{ inputs.version }}"
          for PKG in dist/core/package.json dist/vidyano/package.json; do
            node -e "const fs=require('fs');const p='$PKG';const want=process.argv[1];const v=JSON.parse(fs.readFileSync(p,'utf8')).version; if(v!==want){console.error('‚ùå',p,'has wrong version',v,'!=',want); process.exit(1)}" "$V_IN"
          done
          echo "‚úÖ package.json versions OK"

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-all-${{ inputs.version }}
          path: dist/
          retention-days: 7

      # Expose tags for downstream matrix jobs
      - name: Expose tag outputs
        id: expose
        run: |
          echo "tag=${{ steps.npm-tag.outputs.tag }}" >> $GITHUB_OUTPUT
          echo "version_tag=${{ steps.npm-tag.outputs.version_tag }}" >> $GITHUB_OUTPUT
          echo "next_tag=${{ steps.npm-tag.outputs.next_tag }}" >> $GITHUB_OUTPUT
          echo "is_stable=${{ steps.npm-tag.outputs.is_stable }}" >> $GITHUB_OUTPUT
    outputs:
      tag: ${{ steps.expose.outputs.tag }}
      version_tag: ${{ steps.expose.outputs.version_tag }}
      next_tag: ${{ steps.expose.outputs.next_tag }}
      is_stable: ${{ steps.expose.outputs.is_stable }}

  publish:
    name: Publish (${{ matrix.package.npm }})
    needs: build
    runs-on: ubuntu-latest
    environment: npm-production
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        package:
          - name: core
            npm: "@vidyano/core"
            path: "dist/core"
          - name: vidyano
            npm: "@vidyano/vidyano"
            path: "dist/vidyano"

    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-all-${{ inputs.version }}
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install semver library
        run: npm install --no-save semver@7

      - name: Fail early if version already exists
        shell: bash
        run: |
          PKG="${{ matrix.package.npm }}"
          WANT="${{ inputs.version }}"
          if [ -n "$(npm view "$PKG@$WANT" version 2>/dev/null || echo "")" ]; then
            echo "‚ùå $PKG@$WANT already exists on npm"; exit 1
          fi
          echo "‚úÖ $PKG@$WANT does not exist yet"

      - name: Verify version not downgrading tags
        shell: bash
        run: |
          NEW_VERSION_RAW="${{ inputs.version }}"
          NEW_VERSION=$(node -e "const s=require('semver');const v=s.valid(process.argv[1])||s.valid(s.coerce(process.argv[1])); if(!v){process.exit(1)}; console.log(v)" "$NEW_VERSION_RAW")

          TAG="${{ needs.build.outputs.tag }}"
          VERSION_TAG="${{ needs.build.outputs.version_tag }}"
          PKG="${{ matrix.package.npm }}"
          echo "Checking $PKG..."

          for T in $TAG $VERSION_TAG; do
            [ -n "$T" ] || continue
            echo "  Checking tag: $T"
            CURRENT_VERSION=$(npm view "$PKG@$T" version 2>/dev/null || echo "")
            if [ -z "$CURRENT_VERSION" ]; then
              echo "    Tag '$T' doesn't exist yet - OK"
              continue
            fi
            CURRENT_VERSION=$(node -e "const s=require('semver');const v=s.valid(process.argv[1])||s.valid(s.coerce(process.argv[1])); if(!v){process.exit(1)}; console.log(v)" "$CURRENT_VERSION")
            echo "    Current: $CURRENT_VERSION"
            echo "    New:     $NEW_VERSION"
            if ! node -e "const s=require('semver');process.exit(s.gt(process.argv[1], process.argv[2])?0:1)" "$NEW_VERSION" "$CURRENT_VERSION"; then
              echo "    ‚ùå ERROR: Would downgrade tag '$T' for $PKG"
              exit 1
            fi
            echo "    ‚úÖ OK (new version is higher)"
          done

          echo "‚úÖ No version downgrades detected for $PKG"

      - name: Publish ${{ matrix.package.npm }}
        shell: bash
        run: |
          cd "${{ matrix.package.name }}"

          TAG="${{ needs.build.outputs.tag }}"
          VERSION_TAG="${{ needs.build.outputs.version_tag }}"
          NEXT_TAG="${{ needs.build.outputs.next_tag }}"
          PKG="${{ matrix.package.npm }}"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="--dry-run"
            echo "üîç DRY RUN: Would publish $PKG with tag $TAG"
          else
            FLAGS=""
            echo "üöÄ Publishing $PKG with tag $TAG"
          fi

          npm publish $FLAGS --provenance --access public --tag "$TAG"

          if [ "${{ inputs.dry_run }}" != "true" ]; then
            [ -n "$VERSION_TAG" ] && npm dist-tag add "$PKG@${{ inputs.version }}" "$VERSION_TAG" && echo "‚úÖ Added tag: $VERSION_TAG"
            [ -n "$NEXT_TAG" ] && npm dist-tag add "$PKG@${{ inputs.version }}" "$NEXT_TAG" && echo "‚úÖ Added tag: $NEXT_TAG"
          else
            [ -n "$VERSION_TAG" ] && echo "üîç DRY RUN: Would also add tag $VERSION_TAG"
            [ -n "$NEXT_TAG" ] && echo "üîç DRY RUN: Would also add tag $NEXT_TAG"
          fi

  finalize:
    name: Create Git Tag
    needs: [build, publish]
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Create and push git tag (stable releases only)
        if: needs.build.outputs.is_stable == 'true'
        run: |
          VERSION="${{ inputs.version }}"
          echo "‚úÖ Creating git tag v$VERSION for stable release"
          git tag "v$VERSION"
          git push origin "v$VERSION"
